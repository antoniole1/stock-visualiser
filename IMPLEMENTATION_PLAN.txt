================================================================================
MULTI-PORTFOLIO SUPPORT IMPLEMENTATION PLAN
================================================================================
Project: StockVisualiser
Date Created: 2025-12-23
Status: Planning Phase

================================================================================
EXECUTIVE SUMMARY
================================================================================

This plan outlines a 5-phase approach to add multi-portfolio support to the
StockVisualiser application. Currently, each account has one portfolio. After
implementation:

- Each account can create multiple portfolios (3-5 limit)
- A portfolio landing page appears after login (if multiple portfolios exist)
- A portfolio switcher in the top-right user profile icon allows quick switching
- Full portfolio management (create, rename, delete) via the profile menu

User Flow:
  Login → Landing Page (list of portfolios) → Select Portfolio → Dashboard

Portfolio Switcher (Top-right icon):
  - Switch between portfolios
  - Create new portfolio
  - Rename portfolio
  - Delete portfolio

================================================================================
ARCHITECTURAL ANALYSIS SUMMARY
================================================================================

Current State:
- Single portfolio per (username, password_hash) pair
- Unique constraint on (username, password_hash) in portfolios table
- No separate users table
- Session-based auth with HTTP-only cookies
- Vanilla JavaScript frontend (no framework)
- Flask backend with Supabase (PostgreSQL) database

Key Constraints to Address:
1. Database: Unique constraint prevents multiple portfolios per user
2. Authentication: Username+password is the user identifier (no user_id)
3. Frontend: Single global `portfolio` object, no portfolio selection logic
4. API: All endpoints assume one portfolio per user

================================================================================
PHASE 1: DATABASE SCHEMA UPDATES
================================================================================

Objective:
  Restructure the database to support multiple portfolios per user

Changes Required:

1. CREATE users TABLE
   Location: Supabase PostgreSQL

   SQL:
   CREATE TABLE users (
       id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
       username TEXT UNIQUE NOT NULL,
       password_hash TEXT NOT NULL,
       created_at TIMESTAMP DEFAULT NOW(),
       updated_at TIMESTAMP DEFAULT NOW()
   );

2. MODIFY portfolios TABLE
   Location: Supabase PostgreSQL

   Changes:
   - Add `id` (UUID) as primary key
   - Add `user_id` (UUID) as foreign key to users table
   - Add `is_default` (BOOLEAN) to mark the active/selected portfolio
   - Remove current unique constraint on (username, password_hash)
   - Add new unique constraint on (user_id, portfolio_name)

   SQL:
   ALTER TABLE portfolios ADD COLUMN id UUID PRIMARY KEY DEFAULT gen_random_uuid();
   ALTER TABLE portfolios ADD COLUMN user_id UUID REFERENCES users(id);
   ALTER TABLE portfolios ADD COLUMN is_default BOOLEAN DEFAULT FALSE;
   ALTER TABLE portfolios DROP CONSTRAINT portfolios_username_password_hash_key;
   ALTER TABLE portfolios ADD CONSTRAINT unique_portfolio_per_user
     UNIQUE(user_id, portfolio_name);

3. DATA MIGRATION STRATEGY
   - Extract unique (username, password_hash) pairs from current portfolios table
   - Create corresponding user records in new users table
   - Update portfolios records with user_id foreign key
   - Set first portfolio as is_default = TRUE for each user

First Step to Execute:
  Run SQL migration script to create users table and update portfolios schema

================================================================================
PHASE 2: BACKEND API REFACTORING
================================================================================

Location: /Users/ant/Desktop/StockVisualiser/app.py

Objective:
  Separate user authentication from portfolio loading and add portfolio CRUD

A. Refactor Authentication Layer

Current Flow:
  - Login validates (username, password) against portfolios table
  - Session stores username

New Flow:
  - Login validates (username, password) against users table
  - Session stores user_id, username, AND active_portfolio_id

Session Storage Structure:
  _active_sessions[token] = {
      'user_id': 'uuid',
      'username': 'username',
      'active_portfolio_id': 'portfolio_uuid',
      'created_at': timestamp,
      'expires_at': timestamp
  }

Update validate_session_token() function to return user_id and active_portfolio_id

B. Update Existing Endpoints

1. POST /api/portfolio/login (MODIFY)
   Location: app.py lines 673-725

   Changes:
   - Validate against users table instead of portfolios
   - Return user object + list of portfolios
   - Set active_portfolio_id to is_default portfolio

   Request: {username, password}
   Response: {
     success: true,
     user: {id, username},
     portfolios: [
       {id, name, positions_count, created_at, is_default},
       ...
     ],
     active_portfolio_id: 'uuid'
   }

2. POST /api/portfolio/create (RENAME & MODIFY)
   Rename to: POST /api/users/register
   Location: app.py lines 611-671

   Changes:
   - Create user record in users table
   - Auto-create default portfolio with name "My Portfolio"
   - Set is_default = TRUE for initial portfolio

   Request: {username, password, portfolio_name}
   Response: {
     success: true,
     user: {id, username},
     portfolio: {id, name, positions: [], created_at}
   }

3. GET /api/portfolio/details (MODIFY)
   Location: app.py lines 738-773

   Changes:
   - Add portfolio_id as optional parameter
   - If not provided, use active_portfolio_id from session
   - Validate user owns requested portfolio

   Query Parameters: ?portfolio_id=optional_uuid
   Response: {portfolio object with positions}

4. POST /api/portfolio/save (MODIFY)
   Location: app.py lines 775-815

   Changes:
   - Add portfolio_id parameter to request body
   - Validate user owns that portfolio before saving

   Request: {positions: [...], portfolio_id: 'optional_uuid'}

C. New Endpoints to Add

1. GET /api/user/portfolios
   Purpose: List all portfolios for authenticated user

   Request: (authenticated via session cookie)
   Response: {
     portfolios: [
       {id, name, positions_count, created_at, is_default},
       ...
     ]
   }

2. POST /api/user/portfolios
   Purpose: Create new portfolio

   Request: {portfolio_name: 'name'}
   Response: {
     success: true,
     portfolio: {id, name, positions: [], created_at, is_default: false}
   }

3. PUT /api/user/portfolios/:portfolio_id/select
   Purpose: Set active portfolio

   URL Parameter: portfolio_id
   Request: (empty body)
   Response: {
     success: true,
     active_portfolio_id: 'uuid'
   }

4. PUT /api/user/portfolios/:portfolio_id
   Purpose: Rename portfolio

   URL Parameter: portfolio_id
   Request: {new_name: 'new portfolio name'}
   Response: {
     success: true,
     portfolio: {id, name, ...}
   }

5. DELETE /api/user/portfolios/:portfolio_id
   Purpose: Delete portfolio

   URL Parameter: portfolio_id
   Request: (empty body)
   Response: {success: true}

   Validation: Prevent deleting if it's the user's only portfolio

D. Add Authorization Helper

New function: user_owns_portfolio(user_id, portfolio_id)
- Query: SELECT COUNT(*) FROM portfolios WHERE id = portfolio_id AND user_id = user_id
- Use in all portfolio endpoints to verify authorization

First Step to Execute:
  Create new endpoints for portfolio CRUD operations with proper user authorization

================================================================================
PHASE 3: FRONTEND STATE MANAGEMENT & VIEWS
================================================================================

Location: /Users/ant/Desktop/StockVisualiser/js/app.js
           /Users/ant/Desktop/StockVisualiser/index.html

Objective:
  Update frontend state structure and create portfolio landing page

A. Update Global State Variables

Location: app.js (update lines 12-30 area)

Current State:
  let currentUsername = null;
  let currentPassword = null;
  let portfolio = {...};

New State:
  let currentUser = null;  // {id, username}
  let activePortfolioId = null;  // UUID of selected portfolio
  let availablePortfolios = [];  // [{id, name, positions_count, created_at, is_default}]
  let portfolio = null;  // Current portfolio data
  let currentUsername = null;  // Keep for backward compatibility

B. Create Portfolio Landing Page View

Location: index.html (add after existing views)

New View ID: portfolioLandingView

HTML Structure:
- View container with id="portfolioLandingView"
- Header: "Select Portfolio" or "Your Portfolios"
- Portfolio cards grid/list showing:
  * Portfolio name
  * Number of positions
  * Total portfolio value (cached)
  * Creation date
- "Create New Portfolio" button (if count < 5)
- Empty state message (if no portfolios exist)
- Each card is clickable to select that portfolio

C. Refactor Login Flow

Function: loginPortfolio() - app.js lines 556-578

Changes:
- POST to /api/portfolio/login
- On success:
  * Store currentUser = {id, username}
  * Store activePortfolioId from response
  * Store availablePortfolios from response
  * Hide loginView
  * Show portfolioLandingView (NOT portfolioView directly)
- Hide login view, show landing view

New Function: selectPortfolio(portfolioId)

Purpose: Called when user selects a portfolio from landing page
- Set activePortfolioId = portfolioId
- Fetch portfolio details via GET /api/portfolio/details?portfolio_id=portfolioId
- Load portfolio data into global portfolio object
- Show portfolioView (dashboard)

D. Update App Initialization

Function: initializeApp() - app.js lines 1862-1905

Changes:
- Check if currentUser exists (session active)
- If yes:
  * Fetch available portfolios from GET /api/user/portfolios
  * Load active portfolio
  * Show portfolioLandingView
- If no:
  * Show landingView (login/register screen)

Logic Flow:
  if (currentUser is set) {
    Fetch available portfolios
    if (availablePortfolios.length === 0) {
      Show portfolioLandingView (empty state, prompt to create)
    } else {
      Show portfolioLandingView (with portfolio list)
    }
  } else {
    Show landingView (login/register)
  }

E. Update All API Calls

Affected Functions:
- renderPortfolioDashboard() - Add activePortfolioId to price fetch requests
- savePortfolio() - Include activePortfolioId in POST /api/portfolio/save
- Any position operations - Qualify with portfolio_id

Changes:
- Add ?portfolio_id=activePortfolioId to GET requests
- Add portfolio_id to request body for POST/PUT requests
- Update all fetch calls to pass activePortfolioId

First Step to Execute:
  Create the portfolioLandingView in HTML and build the portfolio list rendering

================================================================================
PHASE 4: PORTFOLIO SWITCHER UI (USER PROFILE DROPDOWN)
================================================================================

Location: /Users/ant/Desktop/StockVisualiser/index.html (line 23)
           /Users/ant/Desktop/StockVisualiser/js/app.js
           /Users/ant/Desktop/StockVisualiser/css/styles.css

Objective:
  Implement portfolio selection and management from top-right user profile icon

A. Add Click Handler to User Profile Button

Current HTML: <button class="btn-user-profile hidden" id="userProfileBtn">

Changes:
- Add click event listener that toggles dropdown menu visibility
- Update updateProfileButtonVisibility() to show button when currentUser is set

B. Create Portfolio Dropdown Menu

Location: index.html (add near user profile button)

HTML Structure:
  <div id="portfolioDropdown" class="portfolio-dropdown hidden">
    <div class="dropdown-header">
      <span id="dropdownUsername">Username</span>
    </div>

    <div class="portfolios-list">
      <!-- List of user's portfolios with radio buttons -->
      <div class="portfolio-item" data-portfolio-id="uuid">
        <input type="radio" name="portfolio" value="uuid">
        <span class="portfolio-name">Portfolio Name</span>
        <span class="positions-count">(5 positions)</span>
        <div class="portfolio-actions">
          <button class="btn-rename" title="Rename"></button>
          <button class="btn-delete" title="Delete"></button>
        </div>
      </div>
    </div>

    <div class="dropdown-divider"></div>

    <button id="createPortfolioBtn" class="btn-create-portfolio">
      + Create Portfolio
    </button>

    <button id="managePortfoliosBtn" class="btn-manage-portfolios">
      Manage Portfolios
    </button>

    <div class="dropdown-divider"></div>

    <button id="logoutBtn" class="btn-logout">Logout</button>
  </div>

C. Create Portfolio Management Modals

1. Create Portfolio Modal
   Location: index.html (add with other modals)

   ID: createPortfolioModal
   Content:
   - Title: "Create New Portfolio"
   - Input field: portfolio name (placeholder: "e.g., Tech Stocks")
   - Validation: 1-50 characters, alphanumeric + spaces
   - Character counter showing current/max
   - Create button
   - Cancel button
   - Show error if portfolio limit (3-5) reached

2. Rename Portfolio Modal
   Location: index.html

   ID: renamePortfolioModal
   Content:
   - Title: "Rename Portfolio"
   - Pre-filled input field with current portfolio name
   - Same validation as create modal
   - Rename button
   - Cancel button

D. Event Handlers to Add

Function: togglePortfolioDropdown()
- Show/hide the portfolio dropdown menu
- Close if clicking outside

Function: selectPortfolioFromDropdown(portfolioId)
- Call selectPortfolio(portfolioId) from Phase 3
- Close dropdown after selection
- Update dashboard if portfolio changed

Function: openCreatePortfolioModal()
- Check if portfolio count < 5
- If limit reached, show error message
- Show create portfolio modal
- Focus on input field

Function: openRenamePortfolioModal(portfolioId)
- Fetch portfolio name
- Pre-fill input with current name
- Show rename modal
- Focus on input field

Function: createNewPortfolio(portfolioName)
- POST to /api/user/portfolios with {portfolio_name}
- On success:
  * Add new portfolio to availablePortfolios array
  * Close modal
  * Refresh portfolio list in dropdown
  * Optionally select the new portfolio

Function: renamePortfolio(portfolioId, newName)
- PUT to /api/user/portfolios/:portfolio_id with {new_name}
- On success:
  * Update availablePortfolios array
  * Close modal
  * Refresh portfolio list in dropdown
  * Update header if renaming active portfolio

Function: deletePortfolio(portfolioId)
- Show confirmation dialog
- Prevent deletion if it's the only portfolio
- DELETE to /api/user/portfolios/:portfolio_id
- On success:
  * Remove from availablePortfolios array
  * Close dropdown
  * If deleted active portfolio, select another one
  * Refresh page

Function: logoutUser()
- POST to /api/portfolio/logout
- Clear currentUser, activePortfolioId, availablePortfolios
- Hide portfolio dropdown
- Show landingView

E. Update Styling

Location: /Users/ant/Desktop/StockVisualiser/css/styles.css

Add Styles For:
- .portfolio-dropdown - Position absolute, top-right, z-index, shadows
- .dropdown-header - Padding, background, typography
- .portfolios-list - Scrollable if many portfolios
- .portfolio-item - Flex layout, hover effects, padding
- .portfolio-actions - Buttons for rename/delete (show on hover)
- .btn-rename, .btn-delete - Icon buttons, sizing
- .dropdown-divider - Separator lines
- .btn-create-portfolio, .btn-manage-portfolios - Link/button styles
- Modal for create/rename (center, overlay, form styling)

First Step to Execute:
  Add click handler to user profile button and create dropdown menu HTML

================================================================================
PHASE 5: DATA MIGRATION & TESTING
================================================================================

Objective:
  Migrate existing users to new schema and ensure backward compatibility

A. Create Migration Script

File to Create: migrate_to_multi_portfolio.py

Purpose:
- Run BEFORE deploying new code
- One-time migration of existing data

Steps:
1. Connect to Supabase database
2. Extract unique (username, password_hash) pairs from portfolios table
3. For each unique user:
   - Create record in users table with (username, password_hash)
   - Get generated user_id
   - Update corresponding portfolio(s) with user_id
   - If user has multiple portfolio records (shouldn't happen), keep first, delete others
   - Set is_default = TRUE for the user's portfolio
4. Verify migration:
   - Every portfolio has a user_id
   - Every user has at least one is_default = TRUE portfolio
   - No orphaned records
5. Log results (users created, portfolios updated, errors)

B. Migration Validation Checks

- Count unique users in old schema vs new schema (should match)
- Verify no portfolio without user_id
- Verify unique constraint (user_id, portfolio_name) is enforced
- Check for foreign key violations

C. Testing Checklist

Unit Tests (test API endpoints):
- ✓ POST /api/users/register creates user and portfolio
- ✓ POST /api/portfolio/login returns user + portfolios list
- ✓ GET /api/user/portfolios lists user's portfolios
- ✓ POST /api/user/portfolios creates portfolio with limit check
- ✓ PUT /api/user/portfolios/:id/select updates active portfolio
- ✓ PUT /api/user/portfolios/:id renames portfolio
- ✓ DELETE /api/user/portfolios/:id deletes portfolio (with checks)

Integration Tests (full workflows):
- ✓ New user: Register → See empty landing → Create portfolio → Dashboard
- ✓ New user: Register → Create 2nd portfolio → Switch via dropdown
- ✓ Existing user: Login → See portfolio landing → Select portfolio → Dashboard
- ✓ Multiple portfolios: Create, rename, delete operations
- ✓ Portfolio limit: Prevent creating more than 5 portfolios
- ✓ Prevent deletion: Can't delete only portfolio
- ✓ Session handling: Active portfolio persists across page refresh

Edge Cases:
- ✓ User with single portfolio (don't show landing page?)
- ✓ Concurrent portfolio switching (simultaneous requests)
- ✓ Portfolio deletion - active portfolio selected, user refreshes
- ✓ Special characters in portfolio names
- ✓ Very long portfolio names (max 50 chars)
- ✓ Duplicate portfolio names (user already has "My Portfolio", try to create again)
- ✓ Log out while dropdown is open
- ✓ Create portfolio while on dashboard, then switch

Browser/Cross-browser:
- ✓ Chrome, Firefox, Safari (if applicable)
- ✓ Mobile responsiveness of dropdown menu
- ✓ Touch/click interactions

First Step to Execute:
  Write the migration script and test on backup database

================================================================================
SEQUENTIAL IMPLEMENTATION ORDER
================================================================================

Phase  Task                          Backend  Frontend  Database
-----  ----------------------------  -------  --------  --------
1      Schema migration              -        -         ✓ Create users table, modify portfolios
2      Auth refactoring              ✓        -         -
2      New API endpoints             ✓        -         -
3      State management              -        ✓         -
3      Landing page view             -        ✓         -
3      Login refactor                ✓        ✓         -
4      Profile button handler        -        ✓         -
4      Dropdown menu                 -        ✓         -
4      Management modals             -        ✓         -
5      Run migration script          -        -         ✓
5      Full testing                  ✓        ✓         -

================================================================================
THE FIRST STEP TO PROCEED
================================================================================

Start with Phase 1 → Phase 2 together:

1. CREATE the users TABLE in Supabase
   - Use SQL provided in Phase 1
   - Verify table was created with correct schema

2. MODIFY the portfolios TABLE
   - Add new columns (id, user_id, is_default)
   - Remove old unique constraint
   - Add new unique constraint on (user_id, portfolio_name)
   - Verify columns exist

3. WRITE the MIGRATION SCRIPT
   - File: migrate_to_multi_portfolio.py
   - Dry-run first (don't commit changes)
   - Test on a copy of the database
   - Document the process

4. REFACTOR LOGIN ENDPOINT
   - Update /api/portfolio/login in app.py to:
     * Authenticate against users table
     * Return portfolio list in response
   - Update session storage structure

5. ADD NEW PORTFOLIO ENDPOINTS
   - GET /api/user/portfolios
   - POST /api/user/portfolios
   - PUT /api/user/portfolios/:id/select
   - PUT /api/user/portfolios/:id
   - DELETE /api/user/portfolios/:id

Once these are complete, Phase 3 (frontend) can proceed independently.

================================================================================
CONFIGURATION NOTES
================================================================================

Portfolio Limits:
- Minimum: 1 portfolio per user (always)
- Maximum: 5 portfolios per user (configurable in create endpoint)
- Enforce in backend validation

Portfolio Landing Page Trigger:
- Show after login if multiple portfolios available
- Skip directly to dashboard if single portfolio (optional optimization)

Session Duration:
- Keep existing 7-day expiration (can be adjusted)
- Store active_portfolio_id in session to persist selection

First-Time User Flow (based on your requirements):
- User registers → Shows empty portfolio landing page
- User must create first portfolio before accessing dashboard
- Default portfolio name: "My Portfolio" (shown as suggestion)

================================================================================
USER PREFERENCES APPLIED
================================================================================

Based on user input during planning:

1. Login Flow: AFTER login landing page
   - User enters credentials → authenticated
   - Shows portfolio landing page with all portfolios
   - User selects one → enters dashboard

2. Profile Actions: Switch + Create + Rename + Delete
   - Full portfolio management from top-right dropdown

3. Portfolio Limit: 3-5 portfolios per user
   - Configured as 5 (soft limit, easily adjustable)

4. First-Time UX: Show empty landing page
   - User creates first portfolio before dashboard access
   - Prompt/guide user to create portfolio

================================================================================
NOTES FOR NEXT SESSION
================================================================================

- This plan assumes Supabase is the primary database
- File-based fallback storage should also be updated (optional for Phase 1)
- No breaking changes to existing clients needed if migration is done correctly
- Recommend testing on staging environment before production deployment
- Consider adding portfolio templates in Phase 2 (optional enhancement)
- User profile icon already exists in HTML - just needs event handler

================================================================================
